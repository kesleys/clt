<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <title>Corra e Lute no Trabalho - CLT: Fugir dos Boletos</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Inter", sans-serif;
        background-color: #f0f0f0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        margin: 0;
        overflow: hidden;
      }

      .game-container {
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        max-width: 800px;
        box-sizing: border-box;
      }

      canvas {
        background-color: #d1d5db;
        border: 2px solid #6b7280;
        border-radius: 8px;
        display: block;
        touch-action: manipulation;
        image-rendering: pixelated;
        image-rendering: -moz-crisp-edges;
        image-rendering: -webkit-optimize-contrast;
        width: 100%;
        max-width: 760px;
        height: auto;
      }

      .pixelated-text {
        font-family: "Press Start 2P", cursive;
        image-rendering: pixelated;
      }

      .message-box {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 30px 40px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        z-index: 100;
        display: none;
        font-size: 1.25rem;
        line-height: 1.75rem;
      }

      .message-box button {
        background-color: #4f46e5;
        color: white;
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1rem;
        margin-top: 20px;
        transition: background-color 0.2s;
      }

      .message-box button:hover {
        background-color: #4338ca;
      }
    </style>

    <link
      href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap"
      rel="stylesheet"
    />
  </head>

  <body>
    <div class="game-container">
      <h1
        class="text-3xl font-bold text-gray-800 mb-4 rounded-lg bg-gray-100 p-3 shadow-sm"
      >
        Fugir dos Boletos: O Minigame
      </h1>

      <div class="flex justify-between w-full max-w-[760px] mb-4 px-2">
        <div class="text-lg text-gray-700">
          Pontos: <span id="score">0</span>
        </div>

        <div class="text-lg text-gray-700">
          Recorde: <span id="highScore">0</span>
        </div>
      </div>
      <canvas id="gameCanvas"></canvas>

      <div class="mt-4 flex flex-col sm:flex-row gap-4">
        <button
          id="jumpButton"
          class="px-6 py-3 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition-colors"
        >
          Pular (Espaço)
        </button>

        <button
          id="resetButton"
          class="px-6 py-3 bg-gray-600 text-white font-semibold rounded-lg shadow-md hover:bg-gray-700 transition-colors"
        >
          Reiniciar
        </button>
      </div>
    </div>

    <div id="messageBox" class="message-box">
      <h2 id="messageTitle" class="text-2xl font-bold mb-4"></h2>

      <p id="messageText" class="mb-6"></p>
      <button id="messageButton">OK</button>
    </div>

    <audio id="gameMusic" loop>
      <source src="assets/audio/trilha.mp3" type="audio/mpeg" />
      Your browser does not support the audio element.
    </audio>

    <script>
      const canvas = document.getElementById("gameCanvas");
      const ctx = canvas.getContext("2d");

      const GAME_WIDTH = 320;
      const GAME_HEIGHT = 180;

      canvas.width = GAME_WIDTH;
      canvas.height = GAME_HEIGHT;

      const scoreDisplay = document.getElementById("score");
      const highScoreDisplay = document.getElementById("highScore");
      const jumpButton = document.getElementById("jumpButton");
      const resetButton = document.getElementById("resetButton");
      const messageBox = document.getElementById("messageBox");
      const messageTitle = document.getElementById("messageTitle");
      const messageText = document.getElementById("messageText");
      const messageButton = document.getElementById("messageButton");
      const gameMusic = document.getElementById("gameMusic");

      let player;
      let obstacles = [];
      let score = 0;
      let highScore = localStorage.getItem("esmagaBoletosHighScore") || 0;
      let gameFrame = 0;
      let gameOver = false;
      let lastObstacleFrame = 0;
      const OBSTACLE_SPAWN_INTERVAL = 90;
      let currentObstacleSpeed = 3;
      const SPEED_INCREASE_INTERVAL = 2;
      const SPEED_INCREASE_AMOUNT = 0.2;

      const PLAYER_SPRITE_WIDTH = 16;
      const PLAYER_SPRITE_HEIGHT = 24;
      const PLAYER_ANIM_FRAMES = 4;
      const PLAYER_ANIM_SPEED = 6;
      let playerImage = new Image();
      playerImage.src = "assets/player/WorkerSheetYellowPurple.png";

      const GROUND_OBSTACLE_IMAGES = [new Image(), new Image(), new Image()];
      const FLYING_OBSTACLE_IMAGES = [new Image(), new Image()];

      GROUND_OBSTACLE_IMAGES[0].src =
        "assets/obstacles/ground/boleto_bravo.png";
      GROUND_OBSTACLE_IMAGES[1].src =
        "assets/obstacles/ground/bolsonaro_bravo.png";
      GROUND_OBSTACLE_IMAGES[2].src = "assets/obstacles/ground/chefe_bravo.png";

      FLYING_OBSTACLE_IMAGES[0].src =
        "assets/obstacles/flying/controle_asas.png";
      FLYING_OBSTACLE_IMAGES[1].src =
        "assets/obstacles/flying/dinheiro_voando.png";

      const OBSTACLE_DEFAULT_WIDTH = 20;
      const OBSTACLE_DEFAULT_HEIGHT = 20;

      let assetsLoaded = 0;
      const totalAssets =
        1 + GROUND_OBSTACLE_IMAGES.length + FLYING_OBSTACLE_IMAGES.length;

      function assetLoaded() {
        assetsLoaded++;
        if (assetsLoaded === totalAssets) {
          console.log("All assets loaded!");
          init();
          resizeCanvas();
          animate();
        }
      }

      playerImage.onload = assetLoaded;
      GROUND_OBSTACLE_IMAGES.forEach((img) => (img.onload = assetLoaded));
      FLYING_OBSTACLE_IMAGES.forEach((img) => (img.onload = assetLoaded));

      let terrainHeights = [];
      const TERRAIN_COLUMN_WIDTH = 2;
      const MAX_TERRAIN_CHANGE = 3;
      const BASE_GROUND_HEIGHT_FROM_BOTTOM = 30;
      const TERRAIN_MIN_HEIGHT_FROM_BOTTOM = 10;
      const TERRAIN_MAX_HEIGHT_FROM_BOTTOM = 50;

      class Player {
        constructor() {
          this.x = 50;
          this.y = getGroundYAtX(this.x) - PLAYER_SPRITE_HEIGHT;
          this.width = PLAYER_SPRITE_WIDTH;
          this.height = PLAYER_SPRITE_HEIGHT;
          this.velocityY = 0;
          this.isJumping = false;
          this.gravity = 0.5;
          this.jumpStrength = -10;
          this.currentFrame = 0;
          this.frameX = 0;
          this.frameY = 0;
        }

        update() {
          const groundY = getGroundYAtX(this.x);

          if (this.isJumping || this.y < groundY - this.height) {
            this.velocityY += this.gravity;
            this.y += this.velocityY;
          }

          if (this.y >= groundY - this.height) {
            this.y = groundY - this.height;
            this.isJumping = false;
            this.velocityY = 0;
          }

          if (!this.isJumping) {
            this.currentFrame =
              Math.floor(gameFrame / PLAYER_ANIM_SPEED) % PLAYER_ANIM_FRAMES;
            this.frameX = this.currentFrame * PLAYER_SPRITE_WIDTH;
            this.frameY = 0;
          } else {
            this.frameX = 0 * PLAYER_SPRITE_WIDTH;
            this.frameY = 0;
          }
        }

        draw() {
          if (playerImage.complete && playerImage.naturalHeight !== 0) {
            ctx.drawImage(
              playerImage,
              this.frameX,
              this.frameY,
              PLAYER_SPRITE_WIDTH,
              PLAYER_SPRITE_HEIGHT,
              this.x,
              this.y,
              this.width,
              this.height
            );
          } else {
            ctx.fillStyle = "#0a7c6f";
            ctx.fillRect(this.x, this.y, this.width, this.height);
          }
        }

        jump() {
          if (!this.isJumping) {
            this.isJumping = true;
            this.velocityY = this.jumpStrength;
          }
        }
      }

      class Obstacle {
        constructor() {
          this.type = Math.random() < 0.7 ? "ground" : "flying";
          this.image = null;
          this.width = OBSTACLE_DEFAULT_WIDTH;
          this.height = OBSTACLE_DEFAULT_HEIGHT;
          this.x = GAME_WIDTH;
          this.speed = currentObstacleSpeed;

          if (this.type === "ground") {
            this.image =
              GROUND_OBSTACLE_IMAGES[
                Math.floor(Math.random() * GROUND_OBSTACLE_IMAGES.length)
              ];
            this.y = getGroundYAtX(this.x) - this.height;
          } else {
            this.image =
              FLYING_OBSTACLE_IMAGES[
                Math.floor(Math.random() * FLYING_OBSTACLE_IMAGES.length)
              ];
            this.width *= 0.8;
            this.height *= 0.8;
            this.y =
              GAME_HEIGHT - PLAYER_SPRITE_HEIGHT - 40 - Math.random() * 30;
          }
        }

        update() {
          this.x -= this.speed;
          if (this.type === "ground") {
            this.y = getGroundYAtX(this.x) - this.height;
          }
        }

        draw() {
          if (
            this.image &&
            this.image.complete &&
            this.image.naturalHeight !== 0
          ) {
            ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
          } else {
            ctx.fillStyle = this.type === "ground" ? "#b91c1c" : "#8b5cf6";
            ctx.fillRect(this.x, this.y, this.width, this.height);
          }
        }
      }

      function initTerrain() {
        terrainHeights = [];
        let currentHeightFromBottom = BASE_GROUND_HEIGHT_FROM_BOTTOM;
        for (let i = 0; i < GAME_WIDTH / TERRAIN_COLUMN_WIDTH + 5; i++) {
          terrainHeights.push(GAME_HEIGHT - currentHeightFromBottom);
          let change = (Math.random() - 0.5) * MAX_TERRAIN_CHANGE;
          currentHeightFromBottom = currentHeightFromBottom + change;
          currentHeightFromBottom = Math.max(
            TERRAIN_MIN_HEIGHT_FROM_BOTTOM,
            Math.min(TERRAIN_MAX_HEIGHT_FROM_BOTTOM, currentHeightFromBottom)
          );
        }
      }

      function updateTerrain() {
        for (let i = 0; i < currentObstacleSpeed; i++) {
          terrainHeights.shift();
          let lastHeightFromBottom =
            GAME_HEIGHT - terrainHeights[terrainHeights.length - 1];
          let newHeightFromBottom =
            lastHeightFromBottom + (Math.random() - 0.5) * MAX_TERRAIN_CHANGE;
          newHeightFromBottom = Math.max(
            TERRAIN_MIN_HEIGHT_FROM_BOTTOM,
            Math.min(TERRAIN_MAX_HEIGHT_FROM_BOTTOM, newHeightFromBottom)
          );
          terrainHeights.push(GAME_HEIGHT - newHeightFromBottom);
        }
      }

      function drawTerrain() {
        ctx.fillStyle = "#6b7280";
        for (let i = 0; i < terrainHeights.length; i++) {
          const x = i * TERRAIN_COLUMN_WIDTH;
          const y = terrainHeights[i];
          const height = GAME_HEIGHT - y;
          ctx.fillRect(x, y, TERRAIN_COLUMN_WIDTH, height);
        }
      }

      function getGroundYAtX(x) {
        const columnIndex = Math.floor(x / TERRAIN_COLUMN_WIDTH);
        if (columnIndex >= 0 && columnIndex < terrainHeights.length) {
          return terrainHeights[columnIndex];
        }
        return GAME_HEIGHT - BASE_GROUND_HEIGHT_FROM_BOTTOM;
      }

      function init() {
        initTerrain();
        player = new Player();
        obstacles = [];
        score = 0;
        gameOver = false;
        gameFrame = 0;
        lastObstacleFrame = 0;
        currentObstacleSpeed = 3;
        updateScoreDisplay();
        hideMessageBox();
        if (gameMusic.paused) {
          gameMusic
            .play()
            .catch((e) => console.log("Music auto-play blocked:", e));
        }
      }

      function animate() {
        if (gameOver) {
          showMessageBox(
            "Fim de Jogo!",
            `Você foi demitido! Sua pontuação: ${score} pontos.`
          );
          gameMusic.pause();
          return;
        }

        ctx.clearRect(0, 0, GAME_WIDTH, GAME_HEIGHT);

        updateTerrain();
        drawTerrain();

        player.update();
        player.draw();

        gameFrame++;
        if (gameFrame - lastObstacleFrame > OBSTACLE_SPAWN_INTERVAL) {
          obstacles.push(new Obstacle());
          lastObstacleFrame = gameFrame;
        }

        obstacles.forEach((obstacle, index) => {
          obstacle.update();
          obstacle.draw();

          if (obstacle.x + obstacle.width < 0) {
            obstacles.splice(index, 1);
            score++;

            if (score > 0 && score % SPEED_INCREASE_INTERVAL === 0) {
              currentObstacleSpeed += SPEED_INCREASE_AMOUNT;
            }
            updateScoreDisplay();
          }

          if (
            player.x < obstacle.x + obstacle.width &&
            player.x + player.width > obstacle.x &&
            player.y < obstacle.y + obstacle.height &&
            player.y + player.height > obstacle.y
          ) {
            gameOver = true;
            if (score > highScore) {
              highScore = score;
              localStorage.setItem("esmagaBoletosHighScore", highScore);
            }
            updateScoreDisplay();
          }
        });

        requestAnimationFrame(animate);
      }

      function updateScoreDisplay() {
        scoreDisplay.textContent = score;
        highScoreDisplay.textContent = highScore;
      }

      function showMessageBox(title, text) {
        messageTitle.textContent = title;
        messageText.textContent = text;
        messageBox.style.display = "block";
      }

      function hideMessageBox() {
        messageBox.style.display = "none";
      }

      window.addEventListener("keydown", (e) => {
        if (e.code === "Space" && !gameOver) {
          player.jump();
        }
      });

      jumpButton.addEventListener("click", () => {
        if (!gameOver) {
          player.jump();
        }
      });

      resetButton.addEventListener("click", () => {
        init();
        animate();
      });

      messageButton.addEventListener("click", () => {
        hideMessageBox();
        init();
        animate();
      });

      function resizeCanvas() {
        const container = canvas.parentElement;
        let containerWidth = container.clientWidth;
        if (containerWidth > 760) {
          containerWidth = 760;
        }
        const aspectRatio = GAME_WIDTH / GAME_HEIGHT;
        let calculatedHeight = containerWidth / aspectRatio;

        canvas.style.width = `${containerWidth}px`;
        canvas.style.height = `${calculatedHeight}px`;
      }

      window.onload = function () {
        resizeCanvas();
        document.body.addEventListener(
          "click",
          () => {
            if (gameMusic.paused) {
              gameMusic
                .play()
                .catch((e) => console.log("Music play failed on click:", e));
            }
          },
          {
            once: true,
          }
        );
      };

      window.addEventListener("resize", resizeCanvas);
    </script>
  </body>
</html>
